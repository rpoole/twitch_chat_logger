function _connect(e){connect=nt.createConnection(e.port,e.server);connect.write("PASS "+e.oauth+"\r\n");connect.write("NICK "+e.nickname+"\r\n");connect.write("USER "+e.nickname+" 8 * :"+e.nickname+"\r\n")}function _createUser(e){if(!users[e]){users[e]={username:e,special:[],color:"#696969",emote:[]}}}function _handleMsg(e,t){if(t.debug){console.log(e)}switch(e.split(" ")[0]){case"PING":connect.write("PONG\r\n");break}switch(e.split(" ")[1]){case"PRIVMSG":var n=e.split(" ")[0].split("!")[0].replace(":","");var r=e.split(" ")[2];var i=e.substr(e.indexOf(":",2)+1);_createUser(n);if(n==="twitchnotify"&&i.indexOf("just subscribed!")){connect.emit("subscribe",r,i.split(" ")[0])}else if(n==="jtv"){if(i.split(" ")[0]==="SPECIALUSER"){_createUser(i.split(" ")[1]);var s=users[i.split(" ")[1]].special;if(us.indexOf(s,i.split(" ")[2])<0){s.push(i.split(" ")[2])}}else if(i.split(" ")[0]==="USERCOLOR"){_createUser(i.split(" ")[1]);users[i.split(" ")[1]].color=i.split(" ")[2]}else if(i.split(" ")[0]==="EMOTESET"){_createUser(i.split(" ")[1]);users[i.split(" ")[1]].emote=i.split(" ")[2]}else if(i.split(" ")[0]==="CLEARCHAT"){if(i.split(" ")[1]){connect.emit("timeout",r,i.split(" ")[1])}else{connect.emit("clearchat",r)}}else if(i==="This room is now in subscribers-only mode."){connect.emit("submode",r,true)}else if(i==="This room is no longer in subscribers-only mode."){connect.emit("submode",r,false)}else if(i.indexOf("This room is now in slow mode. You may send messages every")===0){connect.emit("slowmode",r,true)}else if(i==="This room is no longer in slow mode."){connect.emit("slowmode",r,false)}else if(i.indexOf("This room is now in r9k mode.")===0){connect.emit("r9kmode",r,true)}else if(i==="This room is no longer in r9k mode."){connect.emit("r9kmode",r,false)}else if(i.indexOf("The moderators of this room are")===0){var o=i.substr(i.indexOf(":",2)+2);connect.emit("mods",r,o)}}else{if(i.split(" ")[0]==="ACTION"){connect.emit("action",users[n],r,i.replace("ACTION ","").replace("",""))}else{connect.emit("chat",users[n],r,i)}}break;case"MODE":var r=e.split(" ")[2];var u=e.split(" ")[3];var a=e.split(" ")[4];connect.emit("mode",r,u,a);break;case"JOIN":var r=e.split(" ")[2];var a=e.split(" ")[0].split("!")[0].replace(":","");connect.emit("join",r,a);break;case"PART":var r=e.split(" ")[2];var a=e.split(" ")[0].split("!")[0].replace(":","");connect.emit("part",r,a);break;case"353":var r=e.split(" ")[4];var f=e.substr(e.indexOf(":",2)+1);if(t.twitchclient===1){connect.emit("names",r,f)}break}return e}function _clearCommands(){var e=(new Date).getTime()/1e3;var t=e-30;var n=0;for(var r=commands.length;r>=0;r--){if(commands[r]<t){commands.splice(r,1)}}}var nt=require("net"),rq=require("request"),us=require("underscore");var users={};var commands=[];var channels=[];var connect=function(e,t){var n=this;n.config={autoreconnect:e.autoreconnect||true,channels:e.channels||[],server:e.server||"irc.twitch.tv",port:e.port||6667,nickname:e.nickname||"justinfan"+Math.floor(Math.random()*8e4+1e3),oauth:e.oauth||"TWITCH",debug:e.debug||false,twitchclient:e.twitchclient||3};_connect(n.config);connect.on("close",function(){connect.emit("disconnected","Got disconnected from server.")});connect.on("error",function(e){connect.emit("disconnected",e.code)});connect.on("end",function(){connect.emit("disconnected","Client closed connection.")});connect.on("connected",function(){connect.write("TWITCHCLIENT "+n.config.twitchclient+"\r\n");n.config.channels.forEach(function(e){if(e.charAt(0)!=="#"){e="#"+e}connect.write("JOIN "+e.toLowerCase()+"\r\n")})});connect.on("disconnected",function(e){channels=[];if(n.config.autoreconnect){setTimeout(function(){_connect(n.config)},5e3)}});connect.on("join",function(e,t){if(t===n.config.nickname){channels.push(e)}});connect.on("part",function(e,t){var r=[2,5,9];var i=r.indexOf(5);if(t===n.config.nickname){var i=channels.indexOf(e);if(i>-1){channels.splice(i,1)}}});var r="";connect.on("data",function(e){r+=e;var i=r.split("\r\n");r=i.pop();i.forEach(function(e){var r=_handleMsg(e,n.config);try{if(r.indexOf("You are in a maze of twisty passages")>=0){t(null,connect);connect.emit("connected")}if(r.indexOf("Login unsuccessful")>=0){t("Unable to connect to server. Verify your credentials.",connect);connect.emit("disconnected","Unable to connect to server. Verify your credentials.")}connect.emit("raw",r)}catch(i){throw i}})});setInterval(function(){_clearCommands()},1e4);process.EventEmitter.call(this)};connect.prototype.action=function(e,t){if(e.charAt(0)!=="#"){e="#"+e}if(channels.indexOf(e)>=0){connect.write("PRIVMSG "+e.toLowerCase()+" :/me "+t+"\r\n")}else{console.log("Cannot send action message to "+e+". The bot isn't on the channel.")}};connect.prototype.join=function(e){if(e.charAt(0)!=="#"){e="#"+e}connect.write("JOIN "+e.toLowerCase()+"\r\n")};connect.prototype.mods=function(e){if(e.charAt(0)!=="#"){e="#"+e}if(channels.indexOf(e)>=0){connect.write("PRIVMSG "+e.toLowerCase()+" :/mods\r\n");commands.push((new Date).getTime()/1e3)}else{console.log("Cannot retrieve mods from "+e+". The bot isn't on the channel.")}};connect.prototype.part=function(e){if(e.charAt(0)!=="#"){e="#"+e}connect.write("PART "+e.toLowerCase()+"\r\n")};connect.prototype.say=function(e,t){if(e.charAt(0)!=="#"){e="#"+e}if(channels.indexOf(e)>=0){connect.write("PRIVMSG "+e.toLowerCase()+" :"+t+"\r\n");commands.push((new Date).getTime()/1e3)}else{console.log("Cannot send message to "+e+". The bot isn't on the channel.")}};connect.prototype.send=function(e,t){if(e.charAt(0)!=="#"){e="#"+e}if(t.charAt(0)!=="/"){t="/"+t}if(channels.indexOf(e)>=0){connect.write("PRIVMSG "+e.toLowerCase()+" :"+t+"\r\n");commands.push((new Date).getTime()/1e3)}else{console.log("Cannot send command to "+e+". The bot isn't on the channel.")}};connect.prototype.commandCount=function(){var e=(new Date).getTime()/1e3;var t=e-30;var n=0;for(var r=0;r<commands.length;r++){if(commands[r]>=t){n++}}return n};exports.connect=connect